App.meeting = App.cable.subscriptions.create "MeetingChannel",
  connected: ->
    # Called when the subscription is ready for use on the server

  disconnected: ->
    # Called when the subscription has been terminated by the server

  received: (responseData) ->
    # Called when there's incoming data on the websocket for this channel
    type = responseData.type
    data = responseData.data
    switch
      when type == 'speak'
        speakAction data
      when type == 'join'
        joinAction data
      when type == 'leave'
        leaveAction data
      when type == 'updateUnderstand'
        understandAction data        
  
  speak: (agenda_name, agenda_opinion) ->
    @perform 'speak', agenda_name: agenda_name, agenda_opinion: agenda_opinion

  understandUpdate: (understand, user_id) ->
    @perform 'understandUpdate', understand: understand,user_id: user_id


understandAction = (data) ->
  $("#user-name-display").text('test')

speakAction = (data) ->
  $("#user-name-display").text(data.user.name)
  $("#agenda-name-display").text(data.agenda.name)
  opinion = data.agenda.opinion
  if opinion
    $("#agenda-opinion-display-positive").show()
    $("#agenda-opinion-display-negative").hide()
  else
    $("#agenda-opinion-display-positive").hide()
    $("#agenda-opinion-display-negative").show()

joinAction = (data) ->
  if $("#user-#{data.id}").length <= 0
    newUserNode = document.createElement "li"
    newUserNode.setAttribute 'id', "user-#{data.id}"
    newUserDiv = document.createElement "div"
    newUserDiv.className = "col-sm-2 full-height"
    newUserNameSpan = document.createElement "span"
    newUserNameSpan.innerText = data.name
    newUserImage = document.createElement "IMG"
    newUserImage.src = "<%= asset_path('sarariman.svg') %>"
    newUserDiv.appendChild newUserNameSpan
    newUserDiv.appendChild newUserImage
    newUserNode.appendChild newUserDiv
    $("#users-list").append newUserNode

leaveAction = (data) ->
  $("#user-#{data}").remove()

$(document).ready () ->
  $("#user-speak").on 'click', () ->
    App.meeting.speak($("input[name='agenda_name']").val(), $("input[name='agenda_opinion']:checked").val())
    $("input[name='agenda_name']").val('')
  
  $('.heartRev span').click () ->
    App.meeting.understandUpdate($(this).parent().find('.on').length, 
    $(this).parent().children('p').first().text())
    